#!/usr/bin/rexx
/*
  SVN Revision: $Rev$
  Change Date:  $Date$
*/
/*----------------------------------------------------------------------------*/
/*                                                                            */
/* Copyright (c) 2007 Rexx Language Association. All rights reserved.         */
/*                                                                            */
/* This program and the accompanying materials are made available under       */
/* the terms of the Common Public License v1.0 which accompanies this         */
/* distribution. A copy is also available at the following address:           */
/* http://www.oorexx.org/license.html                                         */
/*                                                                            */
/* Redistribution and use in source and binary forms, with or                 */
/* without modification, are permitted provided that the following            */
/* conditions are met:                                                        */
/*                                                                            */
/* Redistributions of source code must retain the above copyright             */
/* notice, this list of conditions and the following disclaimer.              */
/* Redistributions in binary form must reproduce the above copyright          */
/* notice, this list of conditions and the following disclaimer in            */
/* the documentation and/or other materials provided with the distribution.   */
/*                                                                            */
/* Neither the name of Rexx Language Association nor the names                */
/* of its contributors may be used to endorse or promote products             */
/* derived from this software without specific prior written permission.      */
/*                                                                            */
/* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS        */
/* "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT          */
/* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS          */
/* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT   */
/* OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,      */
/* SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED   */
/* TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,        */
/* OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY     */
/* OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING    */
/* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS         */
/* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.               */
/*                                                                            */
/*----------------------------------------------------------------------------*/
  parse source . . fileSpec

  group = .TestGroup~new(fileSpec)
  group~add(.LabelOption.testGroup)

  if group~isAutomatedTest then return group

  testResult = group~suite~execute~~print

return testResult

::requires 'ooTest.frm' -- load the ooRexxUnit classes

::class "LabelOption.testGroup" subclass ooTestCase public


::method "test_DO_LABEL"
      -- test 1
   i=0
   DO label aha1
      self~assertTrue(.true, "subtest_01: LABEL subkeyword on DO known")
      i=i+1
      do label aha2
         self~assertTrue(.true, "subtest_02: LABEL subkeyword on DO known")
         leave aha2
         self~fail("subtest_03: 'leave aha2' did not work!")
      end
      i=i+1
   END aha1

   self~assertEquals(2, i, "subtest_04: leaving 'aha2'!")

      -- test 2
   i=0
   DO label aha1
      self~assertTrue(.true, "subtest_01: LABEL subkeyword on DO known")
      i=i+1
      do label aha2
         self~assertTrue(.true, "subtest_02: LABEL subkeyword on DO known")
         leave aha1
         self~fail("subtest_03: 'leave aha2' did not work!")
      end aha2
      i=i+1
   END aha1

   self~assertEquals(1, i, "subtest_04: leaving 'aha1'!")

      -- test 2
   i=0
   DO label aha1
      self~assertTrue(.true, "subtest_01: LABEL subkeyword on DO known")
      i=i+1
      do i=1 to 15
         self~assertTrue(.true, "subtest_02: LABEL subkeyword on DO known")
         leave aha1
         self~fail("subtest_03: 'leave aha2' did not work!")
      end i
      i=i+1
   END aha1

   self~assertEquals(1, i, "subtest_04: leaving 'aha1'!")

::method "test_DO_lable_works_with_interpret"
   str="i=0                                                                    ;" -
   "DO label aha1                                                              ;" -
   "   i=i+1                                                                   ;" -
   "   DO label aha2                                                           ;" -
   "      leave aha2                                                           ;" -
   "      i = 9                                                                ;" -
   "   end                                                                     ;" -
   "   i=i+1                                                                   ;" -
   "END aha1                                                                   ;" -

   interpret str

   self~assertNotEquals(0, i, "i must be incremented")
   self~assertNotEquals(10, i, "Leave aha2 did not work")
   self~assertEquals(2, i, "Do loops with label must leave i == 2")


::method "test_DO_LABEL_interpret_with_error"

   -- This test case should produce a synatx error because the label on the END
   -- keyword must match the label on the matching DO.  Test just that and
   -- nothing else.

   str="i=0                                                                    ;" -
   "DO label aha1                                                              ;" -
   "   i=i+1                                                                   ;" -
   "   do label aha2                                                           ;" -
   "      leave aha2                                                           ;" -
   "   end                                                                     ;" -
   "   i=i+1                                                                   ;" -
   "   leave                                                                   ;" -
   "END nixi                                                                   ;" -

   self~expectSyntax(10.2)
   interpret str


::method "test_LOOP_LABEL"
      -- test 1
   i=0
   LOOP label aha1
      self~assertTrue(.true, "subtest_01: LABEL subkeyword on LOOP known")
      i=i+1
      loop label aha2
         self~assertTrue(.true, "subtest_02: LABEL subkeyword on LOOP known")
         leave aha2
         self~fail("subtest_03: 'leave aha2' did not work!")
      end
      i=i+1
      leave aha1
   END aha1

   self~assertEquals(2, i, "subtest_04: leaving 'aha2'!")

      -- test 2
   i=0
   LOOP label aha1
      self~assertTrue(.true, "subtest_01: LABEL subkeyword on LOOP known")
      i=i+1
      loop label aha2
         self~assertTrue(.true, "subtest_02: LABEL subkeyword on LOOP known")
         leave aha1
         self~fail("subtest_03: 'leave aha2' did not work!")
      end aha2
      i=i+1
   END aha1

   self~assertEquals(1, i, "subtest_04: leaving 'aha1'!")

      -- test 3
   i=0
   LOOP label aha1
      self~assertTrue(.true, "subtest_01: LABEL subkeyword on LOOP known")
      i=i+1
      loop i=1 to 15
         self~assertTrue(.true, "subtest_02: LABEL subkeyword on LOOP known")
         leave aha1
         self~fail("subtest_03: 'leave aha2' did not work!")
      end i
      i=i+1
      leave
   END aha1

   self~assertEquals(1, i, "subtest_04: leaving 'aha1'!")

::method 'test_LOOP_label_with_interpret'

   str="i=0                                                                    ;" -
   "LOOP label aha1                                                              ;" -
   "   i=i+1                                                                   ;" -
   "   loop label aha2                                                           ;" -
   "      leave aha2                                                           ;" -
   "      i = 22                                                               ;" -
   "      i = 26                                                               ;" -
   "      i = 27                                                               ;" -
   "   end                                                                     ;" -
   "   i=i+1                                                                   ;" -
   "   leave                                                                   ;" -
   "END aha1                                                                   ;" -

   interpret str

   self~assertNotEquals(0, i, "With LOOP label, i must be incremented")
   self~assertNotEquals(28, i, "Leave aha2 did not work")
   self~assertEquals(2, i, "LOOP with label must leave i == 2")


::method "test_LOOP_LABEL_interpret_with_error_10.2"

   str="i=0                                                                    ;" -
   "LOOP label aha1                                                              ;" -
   "   i=i+1                                                                   ;" -
   "   do label aha2                                                           ;" -
   "      leave aha2                                                           ;" -
   "   end                                                                     ;" -
   "   i=i+1                                                                   ;" -
   "   leave                                                                   ;" -
   "END nixi                                                                   ;" -

   self~expectSyntax( 10.2 )
   interpret str



::method "test_SELECT_LABEL"
      -- test 1
   i=0
   SELECT label aha1
      when i=-1 then nop
      when i=0  then
                do
                   self~assertTrue(.true, "subtest_01: LABEL subkeyword on SELECT known")
                   i=i+1
                   DO label aha2
                      self~assertTrue(.true, "subtest_02: LABEL subkeyword on SELECT known")
                      leave aha2
                      self~fail("subtest_03: 'leave aha2' did not work!")
                   end
                   i=i+1
                   leave aha1
                end
     otherwise  nop
   END aha1

   self~assertEquals(2, i, "subtest_04: leaving 'aha2'!")

      -- test 2
   i=0
   SELECT label aha1
      when i=-1 then nop
      when i=0  then
                do
                   self~assertTrue(.true, "subtest_01: LABEL subkeyword on SELECT known")
                   i=i+1
                   do label aha2
                      self~assertTrue(.true, "subtest_02: LABEL subkeyword on SELECT known")
                      leave aha1
                      self~fail("subtest_03: 'leave aha2' did not work!")
                   end aha2
                   i=i+1
                end
      otherwise  nop
   END aha1

   self~assertEquals(1, i, "subtest_04: leaving 'aha1'!")

      -- test 3
   i=0
   SELECT label aha1
      when i=-1 then nop
      when i=0  then
                do
                   self~assertTrue(.true, "subtest_01: LABEL subkeyword on SELECT known")
                   i=i+1
                   do i=1 to 15
                      self~assertTrue(.true, "subtest_02: LABEL subkeyword on SELECT known")
                      leave aha1
                      self~fail("subtest_03: 'leave aha2' did not work!")
                   end i
                   i=i+1
                   leave
                end
      otherwise  nop
   END aha1

   self~assertEquals(1, i, "subtest_04: leaving 'aha1'!")


::method "test_SELECT_LABEL_error 10.4"

   -- This test should produce a syntax error, test just that.
   str="i=0                       ;" -
   "SELECT label aha1             ;" -
   "   when i=-1 then  nop        ;" -
   "   when i=0 then              ;" -
   "            do                ;" -
   "               i=i+1          ;" -
   "               do label aha2  ;" -
   "                  leave aha2  ;" -
   "                  i = i + 10  ;" -
   "               end            ;" -
   "               i=i+1          ;" -
   "               leave          ;" -
   "            end               ;" -
   "   otherwise nop              ;" -
   "END nixi                      ;" -

   self~expectSyntax( 10.4 )
   interpret str
