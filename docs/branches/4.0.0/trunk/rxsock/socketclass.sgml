<chapter><title>Socket Class Reference</title>
<indexterm><primary>class, socket</primary></indexterm>
<indexterm><primary>socket class</primary></indexterm>
<para>The following sections describe the socket class supplied wit ooRexx.
This class encapsulates the rxsock externale functions into several classes that
improve the functionality if the external function library by extending the
error checking and reducing the amount of code needed in an average rxsock
program.</para>

<section><title>Installation</title>
<indexterm><primary>installation, socket class</primary></indexterm>
<indexterm><primary>socket class installation</primary></indexterm>
<para>The Socket class package is contained in the file socket.cls. This file
must be placed in a directory listed in your PATH. To get access to the class
and methods in the Socket class, include the following statement in your Rexx
program:
<programlisting>
::requires 'socket.cls'
</programlisting></para>
</section>

<section id="clsSocket"><title>The Socket Class</title>
<figure><title>The Socket Class</title>
<mediaobject>
<imageobject>
<!-- Note! - if we include a /imagedata tag we get an error for DSSSL! -->
<imagedata fileref="SocketClass.png" align="left">
</imageobject>
</mediaobject>
</figure>

<section id="mthSocketGetHostByAddr"><title>getHostByAddr (class) method</title>
<indexterm><primary>getHostByAddr class method</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>getHostByAddr class method</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--getHostByAddr(ipaddr)--------------------------------------><
]]>
</programlisting>

<para>This is a class method. It returns an instance of the
<link linkend="clsHostInfo">HostInfo</link> class.
</para>
</section>

<section id="mthSocketGetHostByName"><title>getHostByName (class) method</title>
<indexterm><primary>getHostByName class method</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>getHostByName class method</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--getHostByName(hostname)------------------------------------><
]]>
</programlisting>

<para>This is a class method. It returns an instance of the
<link linkend="clsHostInfo">HostInfo</link> class.
</para>
</section>

<section id="mthSocketGetHostId"><title>getHostId (class) method</title>
<indexterm><primary>getHostId class method</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>getHostId class method</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--getHostId()------------------------------------------------><
]]>
</programlisting>

<para>This is a class method. It returns the dotted decimal host id of the local
machine.
</para>
</section>

<section id="mthSocketAccept"><title>accept method</title>
<indexterm><primary>accept method</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>accept method</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--accept()---------------------------------------------------><
]]>
</programlisting>

<para>This method returns a new socket class instance that is connected to a
remote host that has requested a connection from a server socket.
</para>
</section>

<section id="mthSocketBind"><title>bind method</title>
<indexterm><primary>bind method</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>bind method</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--bind(address)----------------------------------------------><
]]>
</programlisting>

<para>This method binds a socket to a particular local ip address specified by
an instance of the <link linkend="clsInetAddress">InetAddress</link> class
contained in the <emphasis role="italic">address</emphasis> argument.
</para>
</section>

<section id="mthSocketClose"><title>close method</title>
<indexterm><primary>close method</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>close method</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--close()----------------------------------------------------><
]]>
</programlisting>

<para>This method closes this socket instance.
</para>
</section>

<section id="mthSocketConnect"><title>connect method</title>
<indexterm><primary>connect</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>connect</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--connect(address)-------------------------------------------><
]]>
</programlisting>

<para>This method connect the socket to a remote address specified by an
instance of the <link linkend="clsInetAddress">InetAddress</link> class
contained in the <emphasis role="italic">address</emphasis> argument.
</para>
</section>

<section id="mthSocketgetOption"><title>getOption method</title>
<indexterm><primary>getOption</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>getOption</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--getOption(option)------------------------------------------><
]]>
</programlisting>

<para>This method returns the value of the options specified by the <emphasis
role="italic">option</emphasis> argument.
</para>
<para>The <emphasis role="italic">option</emphasis> argument must be one of the
following:
<simplelist>
   <member>SO_BROADCAST  </member>
   <member>SO_DEBUG      </member>
   <member>SO_DONTROUTE  </member>
   <member>SO_ERROR      </member>
   <member>SO_KEEPALIVE  </member>
   <member>SO_LINGER     </member>
   <member>SO_OOBINLINE  </member>
   <member>SO_RCVBUF     </member>
   <member>SO_RCVLOWAT   </member>
   <member>SO_RCVTIMEO   </member>
   <member>SO_REUSEADDR  </member>
   <member>SO_SNDBUF     </member>
   <member>SO_SNDLOWAT   </member>
   <member>SO_SNDTIMEO   </member>
   <member>SO_TYPE       </member>
   <member>SO_USELOOPBACK</member>
</simplelist>
</para>
</section>

<section id="mthSocketgetPeerName"><title>getPeerName method</title>
<indexterm><primary>getPeerName</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>getPeerName</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--getPeerName()----------------------------------------------><
]]>
</programlisting>

<para>This method returns the peer name of the remote connection.
</para>
</section>

<section id="mthSocketGetSockName"><title>getSockName method</title>
<indexterm><primary>getSockName</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>getSockName</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--getSockName()----------------------------------------------><
]]>
</programlisting>

<para>This method returns an instance of the
<link linkend="clsInetAddress">InetAddress</link> class than is the name
information of the remote machine.
</para>
</section>

<section id="mthSocketNew"><title>new (class) method</title>
<indexterm><primary>new</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>class method</primary>
<secondary>new</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--new(--+------------------------------------------+--)------><
          +--domain--+----------------------------+--+
                     +--, type--+--------------+--+
                                +--, protocol--+
]]>
</programlisting>

<para>This method returns a new instance of the
<link linkend="clsSocket">Socket</link>.
</para>
<variablelist>
   <varlistentry>
      <term><emphasis role="bold">domain</emphasis></term>
      <listitem><para>If specified, this argument must be AF_INET.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">type</emphasis></term>
      <listitem><para>If specified, this argument must be SOCK_STREAM,
                    SOCK_DGRAM or SOCK_RAW. SOCK_STREAM is the default.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">protocol</emphasis></term>
      <listitem><para>If specified, this argument must be 0,
                    IPPROTO_UDP or IPPROTO_TCP. 0 is the default.
      </para></listitem>
   </varlistentry>
</variablelist>
</section>

<section id="mthSocketIoctl"><title>ioctl method</title>
<indexterm><primary>ioctl</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>ioctl</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--ioctl(cmd, data)-------------------------------------------><
]]>
</programlisting>

<para>This method sends a special command to the socket. The <emphasis role="italic">
cmd</emphasis> and the <emphasis role="italic">data</emphasis> are not checked
for valid values.
</para>
</section>

<section id="mthSocketListen"><title>listen method</title>
<indexterm><primary>listen</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>listen</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--listen(backlog)--------------------------------------------><
]]>
</programlisting>

<para>This method turns the socket into a server listening socket. The
<emphasis role="italic">backlog</emphasis> is the number of connection
requests the socket should cache.
</para>
</section>

<section id="mthSocketRecv"><title>recv method</title>
<indexterm><primary>recv</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>recv</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--recv(length)-----------------------------------------------><
]]>
</programlisting>

<para>This method recieves data on a socket connection. The
<emphasis role="italic">length</emphasis> is the maximum number of bytes the
socket should receive. This method returns the data received, which could be
less than the maximum length specified.
</para>
</section>

<section id="mthSocketRecvFrom"><title>recvFrom method</title>
<indexterm><primary>recvFrom</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>recvFrom</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--recv(length, address)--------------------------------------><
]]>
</programlisting>

<para>This method recieves data on a socket connection from the specified
<emphasis role="italic">address</emphasis>. The <emphasis role="italic">
address</emphasis> must be an instance of the <link linkend="clsInetAddress">InetAddress
</link> class. The <emphasis role="italic">length</emphasis> is the maximum
number of bytes the socket should receive. This method returns the data
received, which could be less than the maximum length specified.
</para>
</section>

<section id="mthSocketSelect"><title>select method</title>
<indexterm><primary>select</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>seclect</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--select(reads, writes, excepts, timeout)--------------------><
]]>
</programlisting>

<para>This method monitors activity on a set of sockets. It returns the number
of sockets ready for activity. Upon return the input argument arrays will be
reset to only the sockets that are ready.
</para>
<variablelist>
   <varlistentry>
      <term><emphasis role="bold">reads</emphasis></term>
      <listitem><para>An array of socket instances to monitor for read activity.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">writes</emphasis></term>
      <listitem><para>An array of socket instances to monitor for write
                    activity.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">excepts</emphasis></term>
      <listitem><para>An array of socket instances to monitor for exception
                    activity.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">timeout</emphasis></term>
      <listitem><para>The timeout in seconds. This must be a whole number (no
                   fractions allowed).
      </para></listitem>
   </varlistentry>
</variablelist>
</section>

<section id="mthSocketSend"><title>Send method</title>
<indexterm><primary>send</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>send</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--send(data)-------------------------------------------------><
]]>
</programlisting>

<para>This method sends the <emphasis role="italic">data</emphasis> on the
socket. It returns the number of bytes sent, which could be less than the length
of <emphasis role="italic">data</emphasis>.
</para>
</section>

<section id="mthSocketSetOption"><title>setOption method</title>
<indexterm><primary>setOption</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>setOption</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--setOption(name, value)-------------------------------------><
]]>
</programlisting>

<para>This method sets the option given by <emphasis role="italic">name</emphasis>
with the data in <emphasis role="italic">value</emphasis>. See the method
<link linkend="mthSocketGetOption">getOption</link> for the list of valid
<emphasis role="italic">name</emphasis>s.
</para>
</section>

<section id="mthSocketString"><title>string method</title>
<indexterm><primary>string</primary>
<secondary>of Socket class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>string</secondary>
<tertiary>of Socket class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--string()---------------------------------------------------><
]]>
</programlisting>

<para>This method returns the string representing the socket.
</para>
</section>

</section>

<section id="clsInetAddress"><title>The InetAddress Class</title>
<figure><title>The InetAddress Class</title>
<mediaobject>
<imageobject>
<!-- Note! - if we include a /imagedata tag we get an error for DSSSL! -->
<imagedata fileref="InetAddress.png" align="left">
</imageobject>
</mediaobject>
</figure>

<section id="mthSocketAddress"><title>address method</title>
<indexterm><primary>address method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>address method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--address()--------------------------------------------------><
]]>
</programlisting>

<para>This method returns the ip address of the original hostname.
</para>
</section>

<section id="mthInetAddressAddressEqual"><title>address= method</title>
<indexterm><primary>address= method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>address= method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--address(ipaddress)-----------------------------------------><
]]>
</programlisting>

<section id="mthInetAddressFamily"><title>family method)</title>
<indexterm><primary>family method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>family method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--family()---------------------------------------------------><
]]>
</programlisting>

<para>This method returns the ip address family of the original hostname.
</para>
</section>

<section id="mthInetAddressFamilyEqual"><title>family= method</title>
<indexterm><primary>family= method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>family= method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--family(newfamily)------------------------------------------><
]]>
</programlisting>

<para>This method sets the ip address family of the original hostname.
</para>
</section>

<section id="mthInetAddressInit"><title>init method</title>
<indexterm><primary>init method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>init method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--init(hostname, port +------------+--)----------------------><
                        +--, family--+
]]>
</programlisting>

<para>This method creates a new instance of the InetAddress class.
</para>
<variablelist>
   <varlistentry>
      <term><emphasis role="bold">hostname</emphasis></term>
      <listitem><para>The ip address or host name of the host machine.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">port</emphasis></term>
      <listitem><para>The port number of the connection.
      </para></listitem>
   </varlistentry>
   <varlistentry>
      <term><emphasis role="bold">family</emphasis></term>
      <listitem><para>The address family. The only valid value is AF_INET.
      </para></listitem>
   </varlistentry>
</variablelist>
</section>

<section id="mthInetAddressMakeStem"><title>makeStem method</title>
<indexterm><primary>makeStem method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>makeStem method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--makeStem()-------------------------------------------------><
]]>
</programlisting>

<para>This method returns a stem variable set to the current values of the
instance. This method has limited usefulness to the programmer.
</para>
</section>

<section id="mthInetAddressPort"><title>port method</title>
<indexterm><primary>port method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>port method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--port()-----------------------------------------------------><
]]>
</programlisting>

<para>This method returns port number of the original hostname.
</para>
</section>

<section id="mthInetAddressPortEqual"><title>port= method</title>
<indexterm><primary>port= method</primary>
<secondary>of InetAddress class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>port= method</secondary>
<tertiary>of InetAddress class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--port(newport)----------------------------------------------><
]]>
</programlisting>

<para>This method sets the port number of the original hostname.
</para>
</section>

</section>

<section id="clsHostInfo"><title>The HostInfo Class</title>
<figure><title>The HostInfo Class</title>
<mediaobject>
<imageobject>
<!-- Note! - if we include a /imagedata tag we get an error for DSSSL! -->
<imagedata fileref="HostInfo.png" align="left">
</imageobject>
</mediaobject>
</figure>

<section id="mthHostInfoAddr"><title>addr method</title>
<indexterm><primary>addr method</primary>
<secondary>of HostInfo class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>addr method</secondary>
<tertiary>of HostInfo class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--addr()-----------------------------------------------------><
]]>
</programlisting>

<para>This method returns an array of ip addresses of the host.
</para>
</section>

<section id="mthHostInfoAddress"><title>address method</title>
<indexterm><primary>address method</primary>
<secondary>of HostInfo class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>address method</secondary>
<tertiary>of HostInfo class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--address()--------------------------------------------------><
]]>
</programlisting>

<para>This method returns the main ip address of the host.
</para>
</section>

<section id="mthHostInfoAlias"><title>alias method</title>
<indexterm><primary>alias method</primary>
<secondary>of HostInfo class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>alias method</secondary>
<tertiary>of HostInfo class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--alias()----------------------------------------------------><
]]>
</programlisting>

<para>This method returns an array of alias host name of the host.
</para>
</section>

<section id="mthHostInfoName"><title>name method</title>
<indexterm><primary>name method</primary>
<secondary>of HostInfo class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>name method</secondary>
<tertiary>of HostInfo class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--alias()----------------------------------------------------><
]]>
</programlisting>

<para>This method returns the main host name of the host.
</para>
</section>

<section id="mthHostInfoInit"><title>init method</title>
<indexterm><primary>init method</primary>
<secondary>of HostInfo class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>init method</secondary>
<tertiary>of HostInfo class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--init(hostname)---------------------------------------------><
]]>
</programlisting>

<para>This method create an instance of the HostInfo class and sets all the
attribute methods of the instance. The <emphasis role="italic">hostname</emphasis>
can be either a valid DNS host name or an ip address.
</para>
</section>

<section id="mthHostInfoMakeStem"><title>makeStem method</title>
<indexterm><primary>makeStem method</primary>
<secondary>of HostInfo class</secondary></indexterm>
<indexterm><primary>method</primary>
<secondary>makeStem method</secondary>
<tertiary>of HostInfo class</tertiary></indexterm>
<programlisting>
<![CDATA[
>>--makeStem()-------------------------------------------------><
]]>
</programlisting>

<para>This method returns a stem variable set to the current values of the
instance. This method has limited usefulness to the programmer.
</para>
</section>

</section>
</section>

<section id="exampleSocketClass"><title>Socket Class Example</title>
<indexterm><primary>Socket class example</primary></indexterm>
<indexterm><primary>example</primary>
<secondary>of Socket class</secondary></indexterm>
<programlisting>
<![CDATA[
host = '127.0.0.1'
port = 8080
srvr = .server~new(host, port)
call syssleep(1) -- just to let the server get started
call client host, port, 'This is test 1'
call client host, port, 'This is test 2'
call client host, port, 'stop'
return

::requires 'socket.cls'

::routine client
use strict arg host, port, message
-- get a new socket
s = .socket~new()
-- set the server address/port to connection information
addr = .inetaddress~new(host, port)
-- connect to the server
retc = s~connect(addr)
if retc &lt;&gt; 0 then do
   say 'Error' s~errno() 'connecting to server socket.'
   return
   end
-- send the command
retc = s~send(message)
-- receive the command back
say s~recv(4096)
-- close the socket
s~close()
return

::class server
::method init
use strict arg host, port
-- get a new socket
s = .socket~new()
if s = -1 then do
   say 'Error' s~errno() 'creating server socket'
   return
   end
-- set the socket to reuse the addresses assigned to it
retc = s~setoption('SO_REUSEADDR', 1)
if retc = -1 then do
   say 'Error' s~errno() 'setting socket option'
   return
   end
-- bind the socket to an address/port
addr = .inetaddress~new(host, port)
retc = s~bind(addr)
if retc = -1 then do
   say 'Error' s~errno() 'binding socket'
   return
   end
-- mark it as a listening socket
retc = s~listen(3)
if retc = -1 then do
   say 'Error' s~errno() 'making the socket a listening socket'
   return
   end
say 'Server starting'
reply
stop = .false
do while \stop
   -- accept a client connection socket
   cs = s~accept()
   if cs = .nil then do
      say 'Error accepting new socket'
      iterate
      end
   -- receive the command from the client
   cmd = cs~recv(4096)
   -- echo the command back to the client
   cs~send(cmd)
   -- close the client connection socket
   cs~close()
   -- if the command was stop then stop the server
   if cmd~upper() = 'STOP' then do
      stop = .true
      end
   end
-- close the socket
s~close()
return
]]>
</programlisting>
</section>

</chapter>

