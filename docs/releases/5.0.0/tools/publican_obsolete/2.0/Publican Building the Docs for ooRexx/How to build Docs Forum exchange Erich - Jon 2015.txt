
 Erich - 2015-05-22

As I'm trying to update the ooRexx Reference to cover all changes done for 5.0, I need to be able to check how the generated PDF looks like. Without any regular builds I had to figure out how to do a build myself. For all of you who are build process newbies like me, I'd like to share what's needed. (I'm running on Windows 7 64-bit)

We're using DocBook 4.5 XML for documentation, but DocBook isn't something that has to be installed. What has to be installed is Publican, which reads the XML stuff, and uses FOP as the PDF generating stage.

Install Publican

    https://fedorahosted.org/releases/p/u/publican/
    Tars and SRPMs: https://fedorahosted.org/releases/p/u/publican/
    Publican-Installer-3.0.exe

Install FOP

    https://xmlgraphics.apache.org/fop/download.html
    http://www.apache.org/dyn/closer.cgi/xmlgraphics/fop
    http://mirror.cc.columbia.edu/pub/software/apache/xmlgraphics/fop/binaries/fop-1.1-bin.zip

To get Publican to work, I had to

    add "version: 5.0" to docs/trunk/rexxref/publican.cfg
    either add Publican path to PATH: set path="\Program Files (x86)\Publican;"%PATH%, or
    (what I did) use "\Program Files (x86)\Publican\publican.exe" instead of "publican"
    either add FOP path to PATH: set path=\FOP\fop-1.1;%PATH%, or
    (what I did) create a FOP.BAT (in a filder within my PATH) file containing "\FOP\fop-1.1\fop.bat %*"

To actually run a ooRexx Reference build, I had to use the following (I have no idea why I had to add "--common_content="..")

    publican build --formats=pdf --langs=en-US --common_content=".."

The build itself works, although it generates literally thousands of FOP warning or errors.

Questions

    Does anyone have some DocBook / Publican knowledge? Besides the many FOP warnings, there are some quirks (links, surplus whitespace, documentation conventions) for which I'm seeking reasonable solutions for

    I offer to make my intermediate rexxref builds public, if I knew where to upload them. Is there a good place?

    Whatever information, regarding build, we have received from David Ashley - could that be made public, please?

 

    Jon Wolfers
    Jon Wolfers - 2015-05-22

        Whatever information, regarding build, we have received from David Ashley - could that be made public, please?

    Sorry Erich, I've been sitting on that. Here is what David wrote. There is a zip file that goes with it, a mere 72 KBytes so too big for an email attachment, but I could upload it, perhaps to my sandbox - or I can arrange to get it to whoever is going to take this on.

    Jon

        Jon -

        Attached are all the files for the server and the clients. There are some things you need to understand to make use of these files.

            The server is a Fedora 21 64 bit machine configured to use KVM. All the VM commands use a shared library liborxvirt.so which ooRexx uses to issue commands to the virtual machines. The source for this library is in the svn repository.

            VMs are not left in a running state but are instead serially started by the server to perform a build. See the next item for more info.

            You need a server with LOTS of disk space. You not only need space for the VM images, but you also need space for the snapshot that is used to store the state of the running image. Each VM needs its own snapshot image. Instead of starting and shutting down a VM to do a build, I restore it from a saved state if that saved image is available. When the build is done I save the state of the VM into the snapshot file and stop the VM. This is much faster and more reliable that trying to start up and shut down a VM.

            The server and the VM use SSH to communicate. Each is expected to have a copy of the other's public key to prevent password prompts. The exception is the Windows VM. It is always running and uses Windows Scheduler to start the build at a specified time. It also does not use SSH to copy the build output to the server but instead used a mapped drive.

            The file orxbuildmachines.txt in the server directory is the key database the sever uses to drive the builds. It has information about each VM including the ip address, the name that the Virtual Machine Manager knows it by, the account on the VM to use to perform the build, and the command on the VM to run to perform the build. There is an additional boolean field that tells the server whether or not the machine is an actual KVM VM or if it is a remote host. If it is a remote host it skips the start up and shut down procedures.

            Daily builds are controlled by a cron job on the server. Mine started builds at 2:00am under the root account by executing the buildall.sh command in the server directory. This is just a little script that makes sure the current directory is set and then it calls buildall.rex to perform all the builds.

            The dashley directory holds the Linux client code. The key file here in the oorexx.vmchange.properties file. The contents of this file need to be modified to match the VM it resides on. The the file needs to be renamed to oorexx.vm.properties. The contents specify the name of the build rpm/deb, the architecture, and the package type (rpm or deb).

            There are lots of other properties files in the dashley directory. They sort of work the same way as the oorexx.vm.properties file does. If this VM builds an install package then the oorexx.build.properties file is the file it uses. The trunk and branch files can be copied over the main build file if you want to use a different source. Most of the time the build file is the same as the trunk file. The same sort of thing is also used for the docs properties files.

            The testoorexx.sh file is used on a VM to perform unit testing. I had a Fedora VM set up that just did the unit test suite for ooRexx.

            The main control file for the windows build is buildall.cmd. It does two builds, a 32 and a 64 bit build. It does this by calling buildorx.cmd serially with different arguments.

        I am sure you will have other questions. Just email me and I will try to answer them. I developed this code over 10 years so it seems intuitive to me but I am sure it will take some time for others to comprehend it.
